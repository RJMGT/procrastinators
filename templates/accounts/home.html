{% extends 'base.html' %}

{% block title %}Home Feed - Procrast Local{% endblock %}

{% block extra_css %}
<style>
    .posts-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .post-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        border: 1px solid #e0e0e0;
        transition: box-shadow 0.3s;
    }
    
    .post-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .post-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .post-title {
        font-size: 20px;
        font-weight: 600;
        color: #333;
        margin: 0;
    }
    
    .post-author {
        color: #667eea;
        font-weight: 500;
        font-size: 14px;
    }
    
    .post-description {
        color: #555;
        line-height: 1.6;
        margin-bottom: 15px;
        white-space: pre-wrap;
    }
    
    .post-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 15px;
        border-top: 1px solid #e0e0e0;
    }
    
    .post-hours {
        color: #666;
        font-size: 14px;
    }
    
    .post-hours strong {
        color: #764ba2;
    }
    
    .post-date {
        color: #999;
        font-size: 12px;
    }
    
    .like-section {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .vote-buttons {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .like-btn, .dislike-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .like-btn:hover {
        background: #764ba2;
        transform: translateY(-2px);
    }
    
    .like-btn.liked {
        background: #28a745;
    }
    
    .like-btn.liked:hover {
        background: #218838;
    }
    
    .dislike-btn:hover {
        background: #764ba2;
        transform: translateY(-2px);
    }
    
    .dislike-btn.disliked {
        background: #dc3545;
    }
    
    .dislike-btn.disliked:hover {
        background: #c82333;
    }
    
    .like-count, .dislike-count {
        font-weight: 600;
        color: #333;
        font-size: 14px;
    }
    
    .refresh-indicator {
        text-align: center;
        padding: 10px;
        color: #666;
        font-size: 12px;
        margin-bottom: 10px;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
    }
    
    .empty-state h3 {
        color: #333;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="refresh-indicator" id="refresh-indicator" style="display: none;">
    üîÑ Checking for new posts...
</div>
<div class="posts-container" id="posts-container">
    {% if posts %}
        {% for post in posts %}
        <div class="post-card" id="post-{{ post.id }}">
            <div class="post-header">
                <h3 class="post-title">{{ post.title }}</h3>
                <span class="post-author">@{{ post.author.username }}</span>
            </div>
            
            <div class="post-description">{{ post.description }}</div>
            
            <div class="post-meta">
                <div class="post-hours">
                    <strong>‚è∞ {{ post.hours_procrastinated }} hours</strong> procrastinated
                </div>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <span class="post-date">{{ post.created_at|date:"M d, Y H:i" }}</span>
                    <div class="like-section">
                        <div class="vote-buttons">
                            <button 
                                class="like-btn {% if post.id in user_liked_posts %}liked{% endif %}" 
                                data-post-id="{{ post.id }}"
                                onclick="toggleLike({{ post.id }})"
                            >
                                <span>‚ù§Ô∏è</span>
                                <span class="like-text">{% if post.id in user_liked_posts %}Unlike{% else %}Like{% endif %}</span>
                            </button>
                            <span class="like-count" id="like-count-{{ post.id }}">{{ post.like_count }}</span>
                        </div>
                        <div class="vote-buttons">
                            <button 
                                class="dislike-btn {% if post.id in user_disliked_posts %}disliked{% endif %}" 
                                data-post-id="{{ post.id }}"
                                onclick="toggleDislike({{ post.id }})"
                            >
                                <span>üëé</span>
                                <span class="dislike-text">{% if post.id in user_disliked_posts %}Undislike{% else %}Dislike{% endif %}</span>
                            </button>
                            <span class="dislike-count" id="dislike-count-{{ post.id }}">{{ post.dislike_count }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <h3>No posts yet</h3>
            <p>Be the first to share your procrastination story!</p>
            <a href="{% url 'create_post' %}" class="btn" style="margin-top: 20px; display: inline-block; width: auto; padding: 12px 24px;">Create Post</a>
        </div>
    {% endif %}
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function toggleLike(postId) {
    const btn = document.querySelector(`[data-post-id="${postId}"].like-btn`);
    const dislikeBtn = document.querySelector(`[data-post-id="${postId}"].dislike-btn`);
    const likeCountEl = document.getElementById(`like-count-${postId}`);
    const dislikeCountEl = document.getElementById(`dislike-count-${postId}`);
    const likeText = btn.querySelector('.like-text');
    const dislikeText = dislikeBtn.querySelector('.dislike-text');
    
    // Disable buttons during request
    btn.disabled = true;
    dislikeBtn.disabled = true;
    
    const csrftoken = getCookie('csrftoken');
    
    fetch(`/like-post/${postId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            btn.disabled = false;
            dislikeBtn.disabled = false;
            return;
        }
        
        // Update counts
        likeCountEl.textContent = data.like_count;
        dislikeCountEl.textContent = data.dislike_count;
        
        // Update button states - ensure mutual exclusivity
        if (data.liked) {
            btn.classList.add('liked');
            likeText.textContent = 'Unlike';
            // Ensure dislike button is not active
            dislikeBtn.classList.remove('disliked');
            dislikeText.textContent = 'Dislike';
        } else {
            btn.classList.remove('liked');
            likeText.textContent = 'Like';
            // Ensure dislike button is not active (in case it was)
            dislikeBtn.classList.remove('disliked');
            dislikeText.textContent = 'Dislike';
        }
        
        btn.disabled = false;
        dislikeBtn.disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
        btn.disabled = false;
        dislikeBtn.disabled = false;
    });
}

function toggleDislike(postId) {
    const btn = document.querySelector(`[data-post-id="${postId}"].dislike-btn`);
    const likeBtn = document.querySelector(`[data-post-id="${postId}"].like-btn`);
    const likeCountEl = document.getElementById(`like-count-${postId}`);
    const dislikeCountEl = document.getElementById(`dislike-count-${postId}`);
    const dislikeText = btn.querySelector('.dislike-text');
    const likeText = likeBtn.querySelector('.like-text');
    
    // Disable buttons during request
    btn.disabled = true;
    likeBtn.disabled = true;
    
    const csrftoken = getCookie('csrftoken');
    
    fetch(`/dislike-post/${postId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            btn.disabled = false;
            likeBtn.disabled = false;
            return;
        }
        
        // Update counts
        likeCountEl.textContent = data.like_count;
        dislikeCountEl.textContent = data.dislike_count;
        
        // Update button states - ensure mutual exclusivity
        if (data.disliked) {
            btn.classList.add('disliked');
            dislikeText.textContent = 'Undislike';
            // Ensure like button is not active
            likeBtn.classList.remove('liked');
            likeText.textContent = 'Like';
        } else {
            btn.classList.remove('disliked');
            dislikeText.textContent = 'Dislike';
            // Ensure like button is not active (in case it was)
            likeBtn.classList.remove('liked');
            likeText.textContent = 'Like';
        }
        
        btn.disabled = false;
        likeBtn.disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
        btn.disabled = false;
        likeBtn.disabled = false;
    });
}

// Auto-refresh functionality
let lastCheckTime = new Date().toISOString();
let refreshInterval;

function checkForNewPosts() {
    const indicator = document.getElementById('refresh-indicator');
    indicator.style.display = 'block';
    
    fetch(`/check-new-posts/?since=${encodeURIComponent(lastCheckTime)}`)
        .then(response => response.json())
        .then(data => {
            indicator.style.display = 'none';
            
            if (data.count > 0) {
                // Update last check time to the most recent post
                if (data.new_posts.length > 0) {
                    lastCheckTime = data.new_posts[0].created_at;
                }
                
                // Prepend new posts to the feed
                const container = document.getElementById('posts-container');
                data.new_posts.forEach(post => {
                    const postHtml = createPostElement(post);
                    container.insertBefore(postHtml, container.firstChild);
                });
                
                // Show notification
                if (data.count > 0) {
                    const notification = document.createElement('div');
                    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000;';
                    notification.textContent = `‚ú® ${data.count} new post${data.count > 1 ? 's' : ''}!`;
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                }
            }
        })
        .catch(error => {
            console.error('Error checking for new posts:', error);
            indicator.style.display = 'none';
        });
}

function createPostElement(post) {
    const div = document.createElement('div');
    div.className = 'post-card';
    div.id = `post-${post.id}`;
    div.innerHTML = `
        <div class="post-header">
            <h3 class="post-title">${escapeHtml(post.title)}</h3>
            <span class="post-author">@${escapeHtml(post.author)}</span>
        </div>
        <div class="post-description">${escapeHtml(post.description)}</div>
        <div class="post-meta">
            <div class="post-hours">
                <strong>‚è∞ ${post.hours_procrastinated} hours</strong> procrastinated
            </div>
            <div style="display: flex; align-items: center; gap: 20px;">
                <span class="post-date">${formatDate(post.created_at)}</span>
                <div class="like-section">
                    <div class="vote-buttons">
                        <button class="like-btn" data-post-id="${post.id}" onclick="toggleLike(${post.id})">
                            <span>‚ù§Ô∏è</span>
                            <span class="like-text">Like</span>
                        </button>
                        <span class="like-count" id="like-count-${post.id}">${post.like_count}</span>
                    </div>
                    <div class="vote-buttons">
                        <button class="dislike-btn" data-post-id="${post.id}" onclick="toggleDislike(${post.id})">
                            <span>üëé</span>
                            <span class="dislike-text">Dislike</span>
                        </button>
                        <span class="dislike-count" id="dislike-count-${post.id}">${post.dislike_count}</span>
                    </div>
                </div>
            </div>
        </div>
    `;
    return div;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDate(isoString) {
    const date = new Date(isoString);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
}

// Start auto-refresh when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Set initial last check time to now (we'll check for posts created after this)
    lastCheckTime = new Date().toISOString();
    
    // Check for new posts every 10 seconds
    refreshInterval = setInterval(checkForNewPosts, 10000);
});

// Clean up interval when page unloads
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>
{% endblock %}
